# GitHub Actions CI Pipeline for Twitter Translation Bot
# =======================================================
# Added by: AI Assistant on 2025-01-18
# Purpose: Comprehensive CI/CD pipeline with code quality gates
# 
# This workflow runs on every:
# - Push to main branch
# - Pull request to main branch
# - Manual trigger (workflow_dispatch)
#
# Quality Gates:
# 1. Code formatting (Black)
# 2. Import sorting (isort) 
# 3. Linting (Ruff)
# 4. Type checking (MyPy)
# 5. Unit tests (Pytest)
# 6. Coverage reporting
#
# The workflow fails if any quality gate fails, preventing bad code from merging.

name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  quality-checks:
    name: Code Quality & Testing
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Create Required Directories
      run: |
        mkdir -p logs drafts/pending drafts/posted config
        
    - name: Create Test Environment File
      run: |
        # Create minimal .env for testing (no real API keys)
        cat > .env << EOF
        # Test environment - no real API keys
        PRIMARY_TWITTER_CONSUMER_KEY=test_key
        PRIMARY_TWITTER_CONSUMER_SECRET=test_secret
        PRIMARY_TWITTER_ACCESS_TOKEN=test_token
        PRIMARY_TWITTER_ACCESS_TOKEN_SECRET=test_token_secret
        PRIMARY_TWITTER_USERNAME=test_user
        GOOGLE_API_KEY=test_google_key
        GEMINI_MODEL=gemini-1.5-flash
        POLL_INTERVAL_SECONDS=300
        LOG_LEVEL=INFO
        EOF
        
    - name: Code Formatting Check (Black)
      run: |
        echo "ðŸŽ¨ Checking code formatting with Black..."
        black --check --diff --color .
        
    - name: Import Sorting Check (isort)
      run: |
        echo "ðŸ“¦ Checking import sorting with isort..."
        isort --check-only --diff --color .
        
    - name: Linting Check (Ruff)
      run: |
        echo "ðŸ” Running linting checks with Ruff..."
        ruff check . --output-format=github
        
    - name: Type Checking (MyPy)
      run: |
        echo "ðŸ”’ Running type checks with MyPy..."
        mypy src/ --show-error-codes --pretty
      continue-on-error: true  # Type checking warnings shouldn't fail CI initially
      
    - name: Run Tests with Coverage
      run: |
        echo "ðŸ§ª Running test suite with coverage..."
        pytest tests/ -v \
          --cov=src \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-fail-under=75
          
    - name: Upload Coverage to Codecov
      if: matrix.python-version == '3.11'  # Only upload once
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        verbose: true
        
    - name: Archive Coverage Report
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/
        
    - name: Archive Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          logs/
          .coverage
          coverage.xml

  # Security scanning job (optional but recommended)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Run Security Scan (Bandit)
      run: |
        pip install bandit[toml]
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ -f txt
        
    - name: Upload Security Report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: bandit-report.json

  # Dependency vulnerability check
  dependency-scan:
    name: Dependency Vulnerability Scan  
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Run Safety Check
      run: |
        pip install safety
        safety check --json --output safety-report.json || true
        safety check
        
    - name: Upload Safety Report
      uses: actions/upload-artifact@v3
      with:
        name: dependency-scan-report
        path: safety-report.json
